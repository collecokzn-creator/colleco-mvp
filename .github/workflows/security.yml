name: Security Scan

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    # Run weekly security scan every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better secret detection
      
      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified
      
      - name: GitLeaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional: for GitLeaks+
  
  dependency-scan:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true
      
      - name: Run npm audit (production only)
        run: npm audit --production --audit-level=high
      
      - name: Generate audit report
        if: always()
        run: |
          npm audit --json > npm-audit-report.json || true
      
      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-report
          path: npm-audit-report.json
          retention-days: 30
  
  code-scan:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
  
  api-key-check:
    name: Check for Exposed API Keys
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Scan for Google API Keys
        run: |
          echo "Scanning for exposed Google API keys..."
          if grep -r "AIza[0-9A-Za-z_-]\{35\}" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=dist .; then
            echo "âŒ ERROR: Found potential Google API key in repository!"
            echo "Please remove API keys and use environment variables instead."
            exit 1
          else
            echo "âœ… No exposed Google API keys found."
          fi
      
      - name: Scan for AWS Keys
        run: |
          echo "Scanning for exposed AWS keys..."
          if grep -r "AKIA[0-9A-Z]\{16\}" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=dist .; then
            echo "âŒ ERROR: Found potential AWS access key!"
            exit 1
          else
            echo "âœ… No exposed AWS keys found."
          fi
      
      - name: Scan for Stripe Keys
        run: |
          echo "Scanning for exposed Stripe keys..."
          if grep -r "sk_live_[0-9a-zA-Z]\{24,\}" --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=dist .; then
            echo "âŒ ERROR: Found potential Stripe live key!"
            exit 1
          else
            echo "âœ… No exposed Stripe keys found."
          fi
  
  environment-check:
    name: Validate Environment Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check .gitignore includes .env files
        run: |
          if grep -q "^\.env" .gitignore && grep -q "^\.env\.\*" .gitignore; then
            echo "âœ… .gitignore properly configured for environment files"
          else
            echo "âš ï¸  WARNING: .gitignore may not be protecting .env files"
            exit 1
          fi
      
      - name: Check for committed .env files
        run: |
          if git ls-files | grep -E "\.env$|\.env\.local$|\.env\.production$"; then
            echo "âŒ ERROR: .env files found in repository!"
            echo "These files should not be committed."
            exit 1
          else
            echo "âœ… No .env files committed"
          fi
  
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, api-key-check, environment-check]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Security Scan Summary
        id: summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Scan: ${{ needs.secret-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Scan: ${{ needs.dependency-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- API Key Check: ${{ needs.api-key-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Environment Check: ${{ needs.environment-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          if [ "${{ needs.secret-scan.result }}" == "success" ] && \
             [ "${{ needs.dependency-scan.result }}" == "success" ] && \
             [ "${{ needs.api-key-check.result }}" == "success" ] && \
             [ "${{ needs.environment-check.result }}" == "success" ]; then
            echo "âœ… All security checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Some security checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Issue on Security Failure
        if: steps.summary.outputs.status == 'failure' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ Security Scan Failed - ' + new Date().toISOString().split('T')[0];
            const body = `## Security Scan Alert
            
            One or more security scans failed during the scheduled weekly scan.
            
            **Details:**
            - Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            - Branch: ${{ github.ref_name }}
            - Commit: ${{ github.sha }}
            
            **Results:**
            - Secret Scan: ${{ needs.secret-scan.result }}
            - Dependency Scan: ${{ needs.dependency-scan.result }}
            - API Key Check: ${{ needs.api-key-check.result }}
            - Environment Check: ${{ needs.environment-check.result }}
            
            **Action Required:**
            Please review the workflow logs and address any security issues immediately.
            
            ---
            *This issue was created automatically by the Security Scan workflow.*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated']
            });
      
      - name: Send Slack Notification on Failure
        if: steps.summary.outputs.status == 'failure' && vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš¨ Security Scan Failed",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš¨ Security Scan Failed"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Secret Scan:*\n${{ needs.secret-scan.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Dependency Scan:*\n${{ needs.dependency-scan.result }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Logs"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
