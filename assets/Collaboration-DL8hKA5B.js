import{r as o,j as e}from"./index-BCXrhMbA.js";import{p as Z,C as c,R as d,a as _,s as ee,l as B,c as te,b as ae}from"./collabStore-Doz2HPyF.js";const re=[{id:1,ref:"CE-2024-001",clientName:"Alice Johnson",status:"Accepted",itineraryName:"Kruger Safari Adventure",items:[{id:101,name:"Safari Game Drive",category:"activity",price:1500,qty:2,startTime:"06:00",endTime:"09:00",description:"Early morning game drive to spot the Big Five."},{id:102,name:"Safari Lodge",category:"hotel",price:4500,qty:2,startTime:"14:00",description:"Two nights stay in a luxury safari lodge."}]},{id:2,ref:"CE-2024-002",clientName:"Bob Williams",status:"Sent",itineraryName:"Drakensberg Mountain Retreat",items:[{id:201,name:"Guided Mountain Hike",category:"hike",price:1200,qty:4,startTime:"09:00",endTime:"13:00",description:"Explore the majestic peaks and valleys."},{id:202,name:"Picnic Lunch",category:"dining",price:450,qty:4,startTime:"13:00",endTime:"14:00",description:"Enjoy a curated picnic with local delicacies."},{id:203,name:"Stargazing",category:"activity",qty:4,startTime:"20:00",endTime:"21:00",description:"A guided tour of the southern night sky."}]},{id:3,ref:"CE-2024-003",clientName:"Charlie Brown",status:"Draft",itineraryName:"Cape Town City Tour",items:[{id:301,name:"City Tour",category:"car",price:800,qty:1,startTime:"10:00",endTime:"13:00",description:"A guided tour of the city's main attractions."},{id:302,name:"Museum Tickets",category:"activity",price:300,qty:1,startTime:"14:00",endTime:"16:00",description:"Entry to the Iziko South African Museum."}]}];function se({bookingId:a,fromName:i="Client",content:n="Got it, thanks!",authorRole:b="client"}){return Z(a,{authorRole:b,authorName:i,channel:c.whatsapp,content:n})}const g="http://127.0.0.1:4001",A=!0;function f(){return{}}async function u(a){const i=new URLSearchParams;a&&i.set("role",a);const n=i.toString()?`?${i.toString()}`:"",b=await fetch(`${g}/api/collab${n}`,{headers:f()});if(!b.ok)throw new Error("Failed to list threads");return b.json()}async function ne(a,i){const n=await fetch(`${g}/api/collab/${a}/message`,{method:"POST",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify(i)});if(!n.ok)throw new Error("Failed to post message");return n.json()}async function W(a,i){const n=await fetch(`${g}/api/collab/${a}/attachment`,{method:"POST",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify(i)});if(!n.ok)throw new Error("Failed to post attachment");return n.json()}async function ie(a){const i=await fetch(`${g}/webhook/whatsapp`,{method:"POST",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify(a)});if(!i.ok)throw new Error("Failed to deliver WhatsApp webhook");return i.json()}async function oe(a,i){const n=await fetch(`${g}/api/collab/${a}/read`,{method:"POST",headers:{"Content-Type":"application/json",...f()},body:JSON.stringify({role:i})});if(!n.ok)throw new Error("Failed to mark read");return n.json()}const C=[{value:d.agent,label:"Agent"},{value:d.client,label:"Client"},{value:d.productOwner,label:"Product Owner"}];function p({role:a}){const i={[d.agent]:"bg-brand-orange/10 text-brand-brown border border-brand-orange/30",[d.client]:"bg-cream-hover text-brand-brown border border-cream-border",[d.productOwner]:"bg-amber-50 text-amber-800 border border-amber-300",[d.system]:"bg-gray-100 text-gray-700 border border-gray-200"},n=C.find(b=>b.value===a)?.label||a;return e.jsx("span",{className:`px-2 py-0.5 rounded text-xs ${i[a]}`,children:n})}function P({channel:a}){const n={[c.inapp]:{cls:"bg-emerald-50 text-emerald-700",label:"In-App"},[c.whatsapp]:{cls:"bg-green-50 text-green-700",label:"WhatsApp"},[c.email]:{cls:"bg-blue-50 text-blue-700",label:"Email"},[c.sms]:{cls:"bg-purple-50 text-purple-700",label:"SMS"},[c.call]:{cls:"bg-gray-50 text-gray-700",label:"Call"},[c.note]:{cls:"bg-yellow-50 text-yellow-700",label:"Note"}}[a]||{cls:"bg-gray-50 text-gray-700",label:a};return e.jsx("span",{className:`px-2 py-0.5 rounded text-xs border ${n.cls}`,children:n.label})}function he(){const[a,i]=o.useState(()=>localStorage.getItem("collabRole")||d.agent),[n,b]=o.useState(null),[x,h]=o.useState([]),[R,T]=o.useState(""),[y,q]=o.useState("all"),[E,z]=o.useState(c.inapp),[j,I]=o.useState(""),[O,M]=o.useState({recording:!1,mediaRecorder:null,chunks:[]}),[v,F]=o.useState(!1),[N,D]=o.useState(!0);o.useEffect(()=>{(async()=>{try{const t=await u(a);h(t)}catch(t){console.warn("API list failed, falling back to local",t),U()}})()},[a]);function U(){Object.keys(_()).length||ee(re),h(B())}o.useEffect(()=>{let t;try{const s="http://127.0.0.1:4001",m=new URL(s+"/events");m.searchParams.set("role",a),t=new EventSource(m.toString()),t.addEventListener("hello",()=>{});const l=async()=>{try{const S=await u(a);h(S)}catch{}};t.addEventListener("message",l),t.addEventListener("attachment",l),t.addEventListener("read",l)}catch{}return()=>{try{t?.close()}catch{}}},[a]),o.useEffect(()=>{n==null&&x.length&&b(x[0].bookingId)},[x,n]);const r=o.useMemo(()=>x.find(t=>t.bookingId===n),[x,n]),w=o.useMemo(()=>te(r),[r]),k=o.useMemo(()=>ae(r),[r]);o.useEffect(()=>{r&&(async()=>{try{A&&await oe(r.bookingId,a)}catch{}})()},[r,a]),o.useEffect(()=>{},[r,a]),o.useEffect(()=>{if(!v||!r)return;const t=setInterval(async()=>{try{await ie({bookingId:r.bookingId,fromName:"Client",content:"(Auto) WhatsApp: confirmed, thanks!"});const s=await u(a);h(s)}catch{}},12e3);return()=>clearInterval(t)},[v,r,a]);async function J(){const t=R.trim();if(!t||!r)return;const s=j?[j]:[],m={authorRole:a,authorName:C.find(l=>l.value===a)?.label,content:t,channel:E,mentions:s,visibility:y};try{if(A){await ne(r.bookingId,m);const l=await u(a);h(l)}}finally{T(""),I("")}}async function H(t){const s=t.target.files?.[0];if(!s||!r)return;const m={name:s.name,size:s.size,type:s.type,byRole:a,visibility:y};{await W(r.bookingId,m);const l=await u(a);h(l)}}async function G(){try{const t=await navigator.mediaDevices.getUserMedia({audio:!0}),s=new MediaRecorder(t),m=[];s.ondataavailable=l=>{l.data.size>0&&m.push(l.data)},s.onstop=async()=>{const l=new Blob(m,{type:"audio/webm"}),S=await l.arrayBuffer(),K=new Uint8Array(S).byteLength,Q=URL.createObjectURL(l),X=`voice-note-${new Date().toISOString().replace(/[:.]/g,"-")}.webm`;if(A){await W(r.bookingId,{name:X,size:K,type:"audio/webm",byRole:a,url:Q,visibility:y});const Y=await u();h(Y)}},s.start(),M({recording:!0,mediaRecorder:s,chunks:m})}catch(t){console.error("Recording failed",t)}}function V(){try{O.mediaRecorder?.stop(),M({recording:!1,mediaRecorder:null,chunks:[]})}catch{}}function $(t){return t.visibility==="all"?!0:t.visibility==="agent-client"?a===d.agent||a===d.client:t.visibility==="agent-po"?a===d.agent||a===d.productOwner:!0}function L(t){return $(t)}return e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl font-semibold text-brand-brown",children:"Collaboration Workspace"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("button",{className:"lg:hidden px-3 py-2 text-sm border border-cream-border rounded-md bg-white hover:bg-cream-hover",onClick:()=>D(t=>!t),children:[N?"Hide":"Show"," Bookings"]}),e.jsx("select",{className:"border border-cream-border rounded-md px-3 py-2 bg-white hover:bg-cream-hover focus:outline-none focus:ring-2 focus:ring-brand-orange/30",value:a,onChange:t=>{i(t.target.value),localStorage.setItem("collabRole",t.target.value)},children:C.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx(p,{role:a})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[N&&e.jsxs("aside",{className:"lg:col-span-3 bg-cream rounded-lg border border-cream-border shadow-sm",children:[e.jsx("div",{className:"p-4 border-b border-cream-border font-medium text-brand-brown",children:"Bookings"}),e.jsx("ul",{className:"max-h-[70vh] overflow-y-auto",children:x.map(t=>e.jsx("li",{children:e.jsx("button",{onClick:()=>b(t.bookingId),className:`w-full text-left px-4 py-3 hover:bg-cream-hover transition-colors ${n===t.bookingId?"bg-cream-hover":""}`,children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-sm font-semibold text-brand-brown truncate",children:t.title}),e.jsxs("div",{className:"text-xs text-brand-brown/70 truncate",children:[t.ref," • ",t.clientName]})]}),e.jsx("div",{className:"text-xs text-brand-brown/70 flex-shrink-0",children:t.unread?.[a]?e.jsx("span",{className:"inline-block min-w-5 text-center px-1.5 py-0.5 bg-brand-orange text-white rounded-full text-xs",children:t.unread[a]}):null})]})})},t.bookingId))})]}),e.jsxs("section",{className:`lg:col-span-6 bg-white rounded-lg border border-cream-border shadow-sm flex flex-col ${N?"":"lg:col-span-9"}`,children:[e.jsx("div",{className:"p-4 border-b border-cream-border",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"font-semibold text-brand-brown truncate",children:r?.title||"Select a booking"}),e.jsxs("div",{className:"text-xs text-brand-brown/70 truncate",children:[r?.ref," • ",r?.clientName," • Status: ",r?.status]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-brand-brown/60 whitespace-nowrap",children:"Visibility:"}),e.jsxs("select",{className:"border border-cream-border rounded px-2 py-1 text-xs bg-white hover:bg-cream-hover focus:outline-none focus:ring-1 focus:ring-brand-orange/30",value:y,onChange:t=>q(t.target.value),children:[e.jsx("option",{value:"all",children:"All Participants"}),e.jsx("option",{value:"agent-client",children:"Agent + Client"}),e.jsx("option",{value:"agent-po",children:"Agent + Product Owner"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-brand-brown/60 whitespace-nowrap",children:"Channel:"}),e.jsxs("select",{className:"border border-cream-border rounded px-2 py-1 text-xs bg-white hover:bg-cream-hover focus:outline-none focus:ring-1 focus:ring-brand-orange/30",value:E,onChange:t=>z(t.target.value),children:[e.jsx("option",{value:c.inapp,children:"In-App"}),e.jsx("option",{value:c.whatsapp,children:"WhatsApp"}),e.jsx("option",{value:c.email,children:"Email"}),e.jsx("option",{value:c.sms,children:"SMS"}),e.jsx("option",{value:c.note,children:"Note"})]})]})]})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3",children:[(r?.messages||[]).filter($).map(t=>e.jsx("div",{className:`max-w-[85%] ${t.authorRole===a?"ml-auto":""}`,children:e.jsxs("div",{className:`rounded px-3 py-2 border text-sm ${t.authorRole===d.client?"bg-cream-hover border-cream-border":"bg-cream border-cream-border"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(p,{role:t.authorRole}),e.jsx(P,{channel:t.channel}),t.mentions?.length?e.jsx("span",{className:"text-xs text-brand-brown/70",children:t.mentions.map(s=>"@"+s).join(" ")}):null]}),e.jsx("div",{className:"whitespace-pre-wrap text-brand-brown",children:t.content}),e.jsx("div",{className:"text-[11px] text-brand-brown/60 mt-1",children:new Date(t.createdAt).toLocaleString()})]})},t.id)),(r?.attachments||[]).filter(L).length?e.jsxs("div",{className:"pt-2",children:[e.jsx("div",{className:"text-xs font-medium text-brand-brown mb-1",children:"Shared Documents"}),e.jsx("ul",{className:"space-y-1",children:r.attachments.filter(L).map(t=>e.jsxs("li",{className:"text-sm text-brand-brown border-b border-cream-border py-1",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{children:[t.name," ",e.jsxs("span",{className:"text-brand-brown/60",children:["(",Math.ceil((t.size||0)/1024)," KB)"]})]}),e.jsxs("span",{className:"text-xs text-brand-brown/60",children:["by ",e.jsx(p,{role:t.byRole})]})]}),t.type?.startsWith("audio/")&&t.url?e.jsx("audio",{className:"mt-1 w-full",controls:!0,src:t.url}):null]},t.id))})]}):null]}),e.jsxs("div",{className:"p-4 border-t border-cream-border sticky bottom-0 bg-white",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-2",children:[e.jsx("input",{className:"flex-1 min-w-0 border border-cream-border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-orange/30",placeholder:"Write a message… use @client or @productOwner to mention",value:R,onChange:t=>T(t.target.value)}),e.jsxs("select",{className:"border border-cream-border rounded-md px-2 py-2 text-sm bg-white hover:bg-cream-hover focus:outline-none focus:ring-1 focus:ring-brand-orange/30",value:j,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"",children:"@Mention"}),e.jsx("option",{value:"client",children:"@client"}),e.jsx("option",{value:"productOwner",children:"@productOwner"})]}),e.jsxs("label",{className:"cursor-pointer px-3 py-2 text-sm border border-cream-border rounded-md bg-white hover:bg-cream-hover text-brand-brown transition-colors",children:["Attach",e.jsx("input",{type:"file",className:"hidden",onChange:H})]}),O.recording?e.jsx("button",{onClick:V,className:"px-3 py-2 text-sm border border-red-600 rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors",children:"Stop"}):e.jsx("button",{onClick:G,className:"px-3 py-2 text-sm border border-cream-border rounded-md bg-white hover:bg-cream-hover text-brand-brown transition-colors",children:"Record"}),e.jsx("button",{onClick:J,className:"px-4 py-2 text-sm bg-brand-orange text-white rounded-md hover:bg-brand-brown transition-colors",children:"Send"})]}),e.jsx("div",{className:"text-xs text-brand-brown/60",children:"WhatsApp/email sync is simulated. Replies via external channels appear in the timeline with their channel tag."})]})]}),e.jsxs("aside",{className:"lg:col-span-3 bg-cream rounded-lg border border-cream-border shadow-sm p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-brand-brown mb-2",children:"AI Summary"}),e.jsx("div",{className:"text-sm text-brand-brown/80 leading-relaxed",children:k.summary}),k.bullets?.length?e.jsx("ul",{className:"list-disc list-inside text-sm text-brand-brown mt-3 space-y-1",children:k.bullets.map((t,s)=>e.jsx("li",{className:"leading-relaxed",children:t},s))}):null]}),e.jsxs("div",{className:"border-t border-cream-border pt-4",children:[e.jsx("div",{className:"font-medium text-brand-brown mb-3",children:"Collaboration Analytics"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-brand-brown/70 mb-1",children:"Average response time"}),e.jsx("ul",{className:"text-sm text-brand-brown space-y-1",children:Object.entries(w.avgResponseMins||{}).map(([t,s])=>e.jsxs("li",{className:"flex items-center justify-between py-1",children:[e.jsx("span",{children:e.jsx(p,{role:t})}),e.jsxs("span",{className:"font-medium",children:[s,"m"]})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-brand-brown/70 mb-1",children:"Messages per channel"}),e.jsx("ul",{className:"text-sm text-brand-brown space-y-1",children:Object.entries(w.channelCounts||{}).map(([t,s])=>e.jsxs("li",{className:"flex items-center justify-between py-1",children:[e.jsx("span",{children:e.jsx(P,{channel:t})}),e.jsx("span",{className:"font-medium",children:s})]},t))})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-brand-brown/70 mb-1",children:"Awaiting response"}),e.jsx("div",{className:"text-sm text-brand-brown flex flex-wrap gap-1",children:w.awaiting?.length?w.awaiting.map((t,s)=>e.jsx(p,{role:t},s)):e.jsx("span",{className:"text-brand-brown/60",children:"-"})})]})]})]}),e.jsxs("div",{className:"border-t border-cream-border pt-4",children:[e.jsx("div",{className:"font-medium text-brand-brown mb-3",children:"Omnichannel & Push"}),e.jsxs("ul",{className:"text-sm text-brand-brown/90 space-y-1.5 leading-relaxed",children:[e.jsx("li",{children:"• WhatsApp integration stub ready (webhook-style)."}),e.jsx("li",{children:"• Email/SMS fallback simulated via channel tags."}),e.jsx("li",{children:"• Mobile push: add FCM/Expo later for alerts."}),e.jsx("li",{children:"• Open API hooks for Slack/Teams/CRM coming next."})]}),e.jsxs("label",{className:"mt-3 flex items-center gap-2 text-sm text-brand-brown cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:t=>F(t.target.checked),className:"rounded border-cream-border focus:ring-2 focus:ring-brand-orange/30"}),e.jsx("span",{children:"Auto-simulate WhatsApp replies"})]}),e.jsx("button",{onClick:()=>{r&&(se({bookingId:r.bookingId,content:"Replying from WhatsApp: looks good!"}),h(B()))},className:"mt-3 w-full text-sm px-3 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 transition-colors",children:"Simulate WhatsApp reply"})]})]})]})]})})}export{he as default};
