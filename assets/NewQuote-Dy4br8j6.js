import{r as i,e as L,j as e}from"./index-BCXrhMbA.js";import{u as q}from"./useBasketState-zQ4Hh54l.js";import{a as U,c as M,u as B}from"./quotes-BmeI0V5E.js";import{f}from"./currency-SRo7-frQ.js";import"./jspdf.es.min-C6ZdERfm.js";import"./unsupportedIterableToArray-4EWRbQKi.js";const k="quotes:v1",I=()=>"q_"+Math.random().toString(36).slice(2,10),A=()=>"qi_"+Math.random().toString(36).slice(2,10);function _(){const[h,x]=i.useState(()=>{try{const s=localStorage.getItem(k);return s?JSON.parse(s):[]}catch{return[]}});i.useEffect(()=>{try{localStorage.setItem(k,JSON.stringify(h))}catch{}},[h]);const o=i.useCallback((s={})=>{const n={id:I(),clientName:s.clientName||"",clientEmail:s.clientEmail||"",quoteNumber:s.quoteNumber||(()=>{const c=new Date().getFullYear(),l=Math.floor(Math.random()*9e3)+1e3;return`Q-${c}-${l}`})(),dueDate:s.dueDate||"",currency:s.currency||"USD",items:[],taxRate:s.taxRate||0,discountRate:s.discountRate||0,notes:s.notes||"",status:"Draft",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return x(d=>[...d,n]),n.id},[]),b=i.useCallback((s,n)=>{x(d=>d.map(c=>c.id===s?{...c,...n,updatedAt:new Date().toISOString()}:c))},[]),p=i.useCallback(s=>{x(n=>n.filter(d=>d.id!==s))},[]);i.useCallback(s=>{x(n=>{const d=n.find(l=>l.id===s);if(!d)return n;const c={...d,id:I(),status:"Draft",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),items:d.items.map(l=>({...l,id:A()}))};return[...n,c]})},[]);const y=i.useCallback((s,n)=>{x(d=>d.map(c=>{if(c.id!==s)return c;const l={id:A(),title:"",unitPrice:0,quantity:1,...n};return{...c,items:[...c.items,l],updatedAt:new Date().toISOString()}}))},[]),v=i.useCallback((s,n,d)=>{x(c=>c.map(l=>l.id!==s?l:{...l,items:l.items.map(m=>m.id===n?{...m,...d}:m),updatedAt:new Date().toISOString()}))},[]),S=i.useCallback((s,n)=>{x(d=>d.map(c=>c.id===s?{...c,items:c.items.filter(l=>l.id!==n),updatedAt:new Date().toISOString()}:c))},[]),g=i.useCallback(s=>{if(!s)return{subtotal:0,discount:0,tax:0,total:0};const n=(s.items||[]).reduce((t,w)=>t+Number(w.unitPrice||0)*Number(w.quantity||1),0),d=Math.max(0,Math.min(100,Number(s.discountRate||0))),c=d?n*(d/100):0,l=n-c,m=Math.max(0,Number(s.taxRate||0)),u=m?l*(m/100):0,j=l+u;return{subtotal:l,discount:c,tax:u,total:j}},[]),N=i.useCallback((s,n)=>{["Draft","Sent","Accepted","Declined"].includes(n)&&b(s,{status:n})},[b]);return{quotes:h,createQuote:o,updateQuote:b,deleteQuote:p,addItem:y,updateItem:v,removeItem:S,computeTotals:g,setStatus:N}}function K(){const{quotes:h,createQuote:x,updateQuote:o,addItem:b,updateItem:p,removeItem:y,computeTotals:v,setStatus:S}=_(),{paidItems:g}=q(),N=L(),n=new URLSearchParams(N.search).get("edit"),[d,c]=i.useState(n||null),[l,m]=i.useState(!1),[u,j]=i.useState({});i.useEffect(()=>{if(!d){const a=x({});c(a),m(!0),!n&&N.state?.fromBasket&&g.length&&g.forEach(r=>{b(a,{title:r.title,description:r.description,category:r.category,unitPrice:r.price,quantity:r.quantity||1})})}},[d,x,n,N.state,g,b]);const t=h.find(a=>a.id===d);function w(){t&&b(t.id,{title:"New Line Item",unitPrice:0,quantity:1})}function E(){t&&U(t)}if(!t)return e.jsx("div",{className:"p-6",children:"Loading Quote..."});const{subtotal:Q,discount:C,tax:P,total:O}=v(t);async function T(){j({});const a={clientName:t.clientName,clientEmail:t.clientEmail,currency:t.currency,items:t.items,taxRate:t.taxRate,discountRate:t.discountRate,notes:t.notes,status:t.status,dueDate:t.dueDate};try{let r;String(t.id||"").startsWith("tmp_")||!t.id?(r=await M(a),r&&r.id&&o(t.id,{id:r.id,createdAt:r.createdAt||Date.now(),updatedAt:r.updatedAt||Date.now(),quoteNumber:r.quoteNumber||t.quoteNumber})):(r=await B(t.id,a),r&&r.id&&o(t.id,{...r})),m(!1)}catch(r){if(r&&r.body&&Array.isArray(r.body.details)){const D={};for(const R of r.body.details)D[R.field]=R.message;j(D)}else j({_global:"Save failed. Try again."})}}return e.jsxs("div",{className:"px-6 py-8 text-brand-brown max-w-5xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-3xl font-bold",children:n?"Edit Quote":"New Quote"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:E,className:"px-3 py-2 rounded border border-brand-brown text-brand-brown hover:bg-cream-hover",children:"Export PDF"}),e.jsx("button",{onClick:T,className:"px-3 py-2 rounded bg-brand-orange text-white",children:"Save"})]})]}),l&&e.jsx("p",{className:"text-sm text-brand-brown/70 mb-4",children:"A draft quote was created â€” fill in details below."}),e.jsxs("div",{className:"grid gap-6 md:grid-cols-3 mb-8",children:[e.jsxs("div",{className:"space-y-4 md:col-span-2",children:[e.jsxs("div",{className:"bg-cream rounded border border-cream-border p-4 space-y-3",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Quote Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Client Name"}),e.jsx("input",{value:t.clientName,onChange:a=>o(t.id,{clientName:a.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-white"}),u.clientName&&e.jsx("div",{className:"text-red-600 text-sm",children:u.clientName})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Client Email"}),e.jsx("input",{type:"email",value:t.clientEmail||"",onChange:a=>o(t.id,{clientEmail:a.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-white"}),u.clientEmail&&e.jsx("div",{className:"text-red-600 text-sm",children:u.clientEmail})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Currency"}),e.jsxs("select",{value:t.currency,onChange:a=>o(t.id,{currency:a.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-white",children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"EUR",children:"EUR"}),e.jsx("option",{value:"ZAR",children:"ZAR"}),e.jsx("option",{value:"GBP",children:"GBP"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Quote Number"}),e.jsx("input",{value:t.quoteNumber||"",readOnly:!0,className:"px-2 py-1 rounded border border-cream-border bg-white text-brand-brown/60"})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Tax Rate (%)"}),e.jsx("input",{type:"number",min:"0",value:t.taxRate,onChange:a=>o(t.id,{taxRate:Number(a.target.value)}),className:"px-2 py-1 rounded border border-cream-border bg-white"}),u.taxRate&&e.jsx("div",{className:"text-red-600 text-sm",children:u.taxRate})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Discount (%)"}),e.jsx("input",{type:"number",min:"0",max:"100",value:t.discountRate||0,onChange:a=>o(t.id,{discountRate:Number(a.target.value)}),className:"px-2 py-1 rounded border border-cream-border bg-white"}),u.discountRate&&e.jsx("div",{className:"text-red-600 text-sm",children:u.discountRate})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Status"}),e.jsxs("select",{value:t.status,onChange:a=>S(t.id,a.target.value),className:"px-2 py-1 rounded border border-cream-border bg-white",children:[e.jsx("option",{children:"Draft"}),e.jsx("option",{children:"Sent"}),e.jsx("option",{children:"Accepted"}),e.jsx("option",{children:"Declined"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Due Date"}),e.jsx("input",{type:"date",value:t.dueDate||"",onChange:a=>o(t.id,{dueDate:a.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-white"})]})]}),e.jsxs("label",{className:"flex flex-col gap-1 text-sm",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-brand-brown/70",children:"Internal / Client Notes"}),e.jsx("textarea",{rows:3,value:t.notes,onChange:a=>o(t.id,{notes:a.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-white"})]})]}),e.jsxs("div",{className:"bg-cream rounded border border-cream-border p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h2",{className:"font-semibold",children:"Line Items"}),e.jsx("button",{onClick:w,className:"px-2 py-1 text-xs rounded border border-brand-brown text-brand-brown hover:bg-cream-hover",children:"Add Item"})]}),t.items.length===0&&e.jsx("p",{className:"text-sm text-brand-brown/60",children:"No items yet. Add your first line."}),e.jsx("ul",{className:"space-y-3",children:t.items.map(a=>e.jsx("li",{className:"bg-white rounded border border-cream-border p-3",children:e.jsxs("div",{className:"grid md:grid-cols-5 gap-3 text-sm",children:[e.jsxs("label",{className:"flex flex-col gap-1 md:col-span-2",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-wide text-brand-brown/60",children:"Title"}),e.jsx("input",{value:a.title,onChange:r=>p(t.id,a.id,{title:r.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-cream-sand"})]}),e.jsxs("label",{className:"flex flex-col gap-1 md:col-span-2",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-wide text-brand-brown/60",children:"Description"}),e.jsx("input",{value:a.description||"",onChange:r=>p(t.id,a.id,{description:r.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-cream-sand"})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-wide text-brand-brown/60",children:"Category"}),e.jsx("input",{value:a.category||"",onChange:r=>p(t.id,a.id,{category:r.target.value}),className:"px-2 py-1 rounded border border-cream-border bg-cream-sand"})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-wide text-brand-brown/60",children:"Unit Price"}),e.jsx("input",{type:"number",min:"0",value:a.unitPrice,onChange:r=>p(t.id,a.id,{unitPrice:Number(r.target.value)}),className:"px-2 py-1 rounded border border-cream-border bg-cream-sand"})]}),e.jsxs("label",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-wide text-brand-brown/60",children:"Qty"}),e.jsx("input",{type:"number",min:"1",value:a.quantity,onChange:r=>p(t.id,a.id,{quantity:Number(r.target.value)}),className:"px-2 py-1 rounded border border-cream-border bg-cream-sand"})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"text-[10px] uppercase tracking-wide text-brand-brown/60",children:"Line Total"}),e.jsx("div",{className:"px-2 py-1 rounded bg-cream-sand border border-cream-border",children:f(Number(a.unitPrice)*Number(a.quantity||1),t.currency)})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:()=>y(t.id,a.id),className:"mt-auto px-2 py-1 text-xs rounded bg-red-500 text-white hover:bg-red-400",children:"Remove"})})]})},a.id))})]})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-cream rounded border border-cream-border p-4 text-sm",children:[e.jsx("h2",{className:"font-semibold mb-2",children:"Summary"}),e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsx("span",{className:"text-brand-brown/70",children:"Subtotal"}),e.jsx("span",{children:f(Q,t.currency)})]}),C>0&&e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsxs("span",{className:"text-brand-brown/70",children:["Discount (",t.discountRate||0,"%)"]}),e.jsxs("span",{children:["-",f(C,t.currency)]})]}),t.taxRate>0&&e.jsxs("div",{className:"flex justify-between py-1",children:[e.jsxs("span",{className:"text-brand-brown/70",children:["Tax (",t.taxRate,"%)"]}),e.jsx("span",{children:f(P,t.currency)})]}),e.jsxs("div",{className:"flex justify-between py-1 font-semibold border-t border-cream-border mt-2 pt-2",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:f(O,t.currency)})]}),e.jsxs("p",{className:"text-[11px] text-brand-brown/60 mt-3",children:["Status: ",e.jsx("span",{className:"font-medium",children:t.status})]}),e.jsxs("p",{className:"text-[11px] text-brand-brown/60",children:["Created: ",new Date(t.createdAt).toLocaleString()]}),e.jsxs("p",{className:"text-[11px] text-brand-brown/60",children:["Updated: ",new Date(t.updatedAt).toLocaleString()]}),t.dueDate&&e.jsxs("p",{className:"text-[11px] text-brand-brown/60",children:["Due: ",new Date(t.dueDate).toLocaleDateString()]})]})})]})]})}export{K as default};
