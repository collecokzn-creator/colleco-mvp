{"version":3,"file":"Collaboration-CKxtq4Tp.js","sources":["../../src/mockData.js","../../src/utils/whatsappStub.js","../../src/api/collabApi.js","../../src/pages/Collaboration.jsx"],"sourcesContent":["export const icons = {\r\n  flight: \"ðŸ›«\",\r\n  hotel: \"ðŸ¨\",\r\n  car: \"ðŸš—\",\r\n  hike: \"ðŸ¥¾\",\r\n  dining: \"ðŸ½ï¸\",\r\n  activity: \"ðŸŽ‰\",\r\n  default: \"âœ¨\",\r\n}\r\n\r\nexport const mockBookings = [\r\n  {\r\n    id: 1,\r\n    ref: \"CE-2024-001\",\r\n    clientName: \"Alice Johnson\",\r\n    status: \"Accepted\",\r\n    itineraryName: \"Kruger Safari Adventure\",\r\n    items: [\r\n      {\r\n        id: 101,\r\n        name: \"Safari Game Drive\",\r\n        category: \"activity\",\r\n        price: 1500,\r\n        qty: 2,\r\n        startTime: \"06:00\",\r\n        endTime: \"09:00\",\r\n        description: \"Early morning game drive to spot the Big Five.\",\r\n      },\r\n      {\r\n        id: 102,\r\n        name: \"Safari Lodge\",\r\n        category: \"hotel\",\r\n        price: 4500,\r\n        qty: 2,\r\n        startTime: \"14:00\",\r\n        description: \"Two nights stay in a luxury safari lodge.\",\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    id: 2,\r\n    ref: \"CE-2024-002\",\r\n    clientName: \"Bob Williams\",\r\n    status: \"Sent\",\r\n    itineraryName: \"Drakensberg Mountain Retreat\",\r\n    items: [\r\n      {\r\n        id: 201,\r\n        name: \"Guided Mountain Hike\",\r\n        category: \"hike\",\r\n        price: 1200,\r\n        qty: 4,\r\n        startTime: \"09:00\",\r\n        endTime: \"13:00\",\r\n        description: \"Explore the majestic peaks and valleys.\",\r\n      },\r\n      {\r\n        id: 202,\r\n        name: \"Picnic Lunch\",\r\n        category: \"dining\",\r\n        price: 450,\r\n        qty: 4,\r\n        startTime: \"13:00\",\r\n        endTime: \"14:00\",\r\n        description: \"Enjoy a curated picnic with local delicacies.\",\r\n      },\r\n      {\r\n        id: 203,\r\n        name: \"Stargazing\",\r\n        category: \"activity\",\r\n        // No price for this item\r\n        qty: 4,\r\n        startTime: \"20:00\",\r\n        endTime: \"21:00\",\r\n        description: \"A guided tour of the southern night sky.\",\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    id: 3,\r\n    ref: \"CE-2024-003\",\r\n    clientName: \"Charlie Brown\",\r\n    status: \"Draft\",\r\n    itineraryName: \"Cape Town City Tour\",\r\n    items: [\r\n      { id: 301, name: \"City Tour\", category: \"car\", price: 800, qty: 1, startTime: \"10:00\", endTime: \"13:00\", description: \"A guided tour of the city's main attractions.\" },\r\n      { id: 302, name: \"Museum Tickets\", category: \"activity\", price: 300, qty: 1, startTime: \"14:00\", endTime: \"16:00\", description: \"Entry to the Iziko South African Museum.\" },\r\n    ],\r\n  },\r\n]\r\n\r\nexport const productCatalog = [\r\n  { id: 101, name: \"Safari Game Drive\", category: \"activity\", price: 1500, qty: 1, description: \"Early morning game drive to spot the Big Five.\" },\r\n  { id: 102, name: \"Safari Lodge\", category: \"hotel\", price: 4500, qty: 1, description: \"Two nights stay in a luxury safari lodge.\" },\r\n  { id: 201, name: \"Guided Mountain Hike\", category: \"hike\", price: 1200, qty: 1, description: \"Explore the majestic peaks and valleys.\" },\r\n  { id: 202, name: \"Picnic Lunch\", category: \"dining\", price: 450, qty: 1, description: \"Enjoy a curated picnic with local delicacies.\" },\r\n  { id: 203, name: \"Stargazing\", category: \"activity\", qty: 1, description: \"A guided tour of the southern night sky.\" },\r\n  { id: 301, name: \"City Tour\", category: \"car\", price: 800, qty: 1, description: \"A guided tour of the city's main attractions.\" },\r\n  { id: 302, name: \"Museum Tickets\", category: \"activity\", price: 300, qty: 1, description: \"Entry to the Iziko South African Museum.\" },\r\n  { id: 401, name: \"Return Flight CPT-JNB\", category: \"flight\", price: 3500, qty: 1, description: \"Economy class return flights.\" },\r\n  { id: 402, name: \"Car Rental\", category: \"car\", price: 750, qty: 1, description: \"Standard sedan for 3 days.\" },\r\n]\r\n\r\nexport const mockItinerary = {\r\n  title: \"Adventure in Drakensberg\",\r\n  clientName: \"John Doe\",\r\n  ref: \"COL12345\",\r\n  days: [\r\n    {\r\n      day: 1, title: \"Arrival & Check-In\", start: \"14:00\", end: \"18:00\", description: \"Check in at the lodge.\", icon: \"ðŸ¨\", map: true },\r\n    { day: 2, title: \"Hiking Trail\", start: \"08:00\", end: \"16:00\", description: \"Guided hike.\", icon: \"ðŸ¥¾\", map: true },\r\n  ],\r\n  inclusions: [\"Accommodation\", \"Breakfast\", \"Guided Hike\"],\r\n  exclusions: [\"Flights\", \"Travel insurance\"],\r\n};","// Simulates receiving an inbound WhatsApp message and logging it to a thread.\r\nimport { CHANNELS, postMessage } from \"./collabStore\";\r\n\r\nexport function simulateInboundWhatsApp({ bookingId, fromName = \"Client\", content = \"Got it, thanks!\", authorRole = \"client\" }) {\r\n  return postMessage(bookingId, {\r\n    authorRole,\r\n    authorName: fromName,\r\n    channel: CHANNELS.whatsapp,\r\n    content,\r\n  });\r\n}\r\n","// Minimal client for the local collab API server\r\nconst BASE = import.meta.env.VITE_API_BASE || '';\r\nconst TOKEN = import.meta.env.VITE_API_TOKEN || '';\r\nexport const isApiEnabled = !!import.meta.env.VITE_API_BASE;\r\n\r\nfunction authHeaders() {\r\n  return TOKEN ? { Authorization: `Bearer ${TOKEN}` } : {};\r\n}\r\n\r\nexport async function listThreads(role) {\r\n  const qp = new URLSearchParams();\r\n  if (role) qp.set('role', role);\r\n  const q = qp.toString() ? `?${qp.toString()}` : '';\r\n  const res = await fetch(`${BASE}/api/collab${q}`, { headers: authHeaders() });\r\n  if (!res.ok) throw new Error('Failed to list threads');\r\n  return res.json();\r\n}\r\n\r\nexport async function getThread(bookingId, role) {\r\n  const qp = new URLSearchParams();\r\n  if (role) qp.set('role', role);\r\n  const q = qp.toString() ? `?${qp.toString()}` : '';\r\n  const res = await fetch(`${BASE}/api/collab/${bookingId}${q}`, { headers: authHeaders() });\r\n  if (!res.ok) throw new Error('Thread not found');\r\n  return res.json();\r\n}\r\n\r\nexport async function postMessage(bookingId, payload) {\r\n  const res = await fetch(`${BASE}/api/collab/${bookingId}/message`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json', ...authHeaders() },\r\n    body: JSON.stringify(payload),\r\n  });\r\n  if (!res.ok) throw new Error('Failed to post message');\r\n  return res.json();\r\n}\r\n\r\nexport async function postAttachment(bookingId, payload) {\r\n  const res = await fetch(`${BASE}/api/collab/${bookingId}/attachment`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json', ...authHeaders() },\r\n    body: JSON.stringify(payload),\r\n  });\r\n  if (!res.ok) throw new Error('Failed to post attachment');\r\n  return res.json();\r\n}\r\n\r\nexport async function whatsappInbound(payload) {\r\n  const res = await fetch(`${BASE}/webhook/whatsapp`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json', ...authHeaders() },\r\n    body: JSON.stringify(payload),\r\n  });\r\n  if (!res.ok) throw new Error('Failed to deliver WhatsApp webhook');\r\n  return res.json();\r\n}\r\n\r\nexport async function markRead(bookingId, role) {\r\n  const res = await fetch(`${BASE}/api/collab/${bookingId}/read`, {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json', ...authHeaders() },\r\n    body: JSON.stringify({ role }),\r\n  });\r\n  if (!res.ok) throw new Error('Failed to mark read');\r\n  return res.json();\r\n}\r\n","import React, { useEffect, useMemo, useState } from \"react\";\r\nimport { mockBookings } from \"../mockData\";\r\nimport {\r\n  addAttachment as addLocalAttachment,\r\n  CHANNELS,\r\n  computeAnalytics,\r\n  listThreads as listLocalThreads,\r\n  loadThreads,\r\n  markRead as markLocalRead,\r\n  postMessage as postLocalMessage,\r\n  ROLES,\r\n  seedFromBookings,\r\n  summarizeThread,\r\n  onCollabEvent,\r\n} from \"../utils/collabStore\";\r\nimport { simulateInboundWhatsApp } from \"../utils/whatsappStub\";\r\nimport { notify } from \"../utils/notify\";\r\nimport { listThreads as apiList, postMessage as apiPost, postAttachment as apiAttach, whatsappInbound as apiWhatsApp, markRead as apiMarkRead, isApiEnabled } from \"../api/collabApi\";\r\n\r\nconst roleOptions = [\r\n  { value: ROLES.agent, label: \"Agent\" },\r\n  { value: ROLES.client, label: \"Client\" },\r\n  { value: ROLES.productOwner, label: \"Product Owner\" },\r\n];\r\n\r\nfunction RoleBadge({ role }) {\r\n  const map = {\r\n    [ROLES.agent]: \"bg-brand-orange/10 text-brand-brown border border-brand-orange/30\",\r\n    [ROLES.client]: \"bg-cream-hover text-brand-brown border border-cream-border\",\r\n    [ROLES.productOwner]: \"bg-amber-50 text-amber-800 border border-amber-300\",\r\n    [ROLES.system]: \"bg-gray-100 text-gray-700 border border-gray-200\",\r\n  };\r\n  const label = roleOptions.find(r => r.value === role)?.label || role;\r\n  return <span className={`px-2 py-0.5 rounded text-xs ${map[role]}`}>{label}</span>;\r\n}\r\n\r\nfunction ChannelTag({ channel }) {\r\n  const map = {\r\n    [CHANNELS.inapp]: { cls: \"bg-emerald-50 text-emerald-700\", label: \"In-App\" },\r\n    [CHANNELS.whatsapp]: { cls: \"bg-green-50 text-green-700\", label: \"WhatsApp\" },\r\n    [CHANNELS.email]: { cls: \"bg-blue-50 text-blue-700\", label: \"Email\" },\r\n    [CHANNELS.sms]: { cls: \"bg-purple-50 text-purple-700\", label: \"SMS\" },\r\n    [CHANNELS.call]: { cls: \"bg-gray-50 text-gray-700\", label: \"Call\" },\r\n    [CHANNELS.note]: { cls: \"bg-yellow-50 text-yellow-700\", label: \"Note\" },\r\n  };\r\n  const it = map[channel] || { cls: \"bg-gray-50 text-gray-700\", label: channel };\r\n  return <span className={`px-2 py-0.5 rounded text-xs border ${it.cls}`}>{it.label}</span>;\r\n}\r\n\r\nexport default function Collaboration() {\r\n  const [currentRole, setCurrentRole] = useState(() => localStorage.getItem(\"collabRole\") || ROLES.agent);\r\n  const [bookingId, setBookingId] = useState(null);\r\n  const [threads, setThreads] = useState([]);\r\n  const [message, setMessage] = useState(\"\");\r\n  const [visibility, setVisibility] = useState(\"all\");\r\n  const [channel, setChannel] = useState(CHANNELS.inapp);\r\n  const [mention, setMention] = useState(\"\");\r\n  const [recState, setRecState] = useState({ recording: false, mediaRecorder: null, chunks: [] });\r\n  const [autoSync, setAutoSync] = useState(false);\r\n  const [sidebarOpen, setSidebarOpen] = useState(true);\r\n\r\n  // Initial load + reload on role change\r\n  useEffect(() => {\r\n    (async () => {\r\n      if (isApiEnabled) {\r\n        try {\r\n          const list = await apiList(currentRole);\r\n          setThreads(list);\r\n        } catch (e) {\r\n          console.warn(\"API list failed, falling back to local\", e);\r\n          ensureLocalSeed();\r\n        }\r\n      } else {\r\n        ensureLocalSeed();\r\n      }\r\n    })();\r\n  }, [currentRole]);\r\n\r\n  function ensureLocalSeed() {\r\n    if (!Object.keys(loadThreads()).length) {\r\n      seedFromBookings(mockBookings);\r\n    }\r\n    setThreads(listLocalThreads());\r\n  }\r\n\r\n  // SSE subscription in API mode\r\n  // Subscribe based on `currentRole` and API availability\r\n  useEffect(() => {\r\n    if (!isApiEnabled) return undefined;\r\n    let es;\r\n    try {\r\n      const base = (import.meta.env.VITE_API_BASE || \"\");\r\n      const url = new URL(base + \"/events\");\r\n      url.searchParams.set(\"role\", currentRole);\r\n      if (import.meta.env.VITE_API_TOKEN) url.searchParams.set(\"token\", import.meta.env.VITE_API_TOKEN);\r\n      es = new EventSource(url.toString());\r\n      es.addEventListener(\"hello\", () => {/* noop */});\r\n      const refresh = async () => { try { const list = await apiList(currentRole); setThreads(list); } catch {} };\r\n      es.addEventListener(\"message\", refresh);\r\n      es.addEventListener(\"attachment\", refresh);\r\n      es.addEventListener(\"read\", refresh);\r\n    } catch {}\r\n    return () => { try { es?.close(); } catch {} };\r\n  }, [currentRole]);\r\n\r\n  // Ensure selection reacts to threads list and current bookingId\r\n  useEffect(() => {\r\n    if (bookingId == null && threads.length) setBookingId(threads[0].bookingId);\r\n  }, [threads, bookingId]);\r\n\r\n  const thread = useMemo(() => threads.find(t => t.bookingId === bookingId), [threads, bookingId]);\r\n  const analytics = useMemo(() => computeAnalytics(thread), [thread]);\r\n  const summary = useMemo(() => summarizeThread(thread), [thread]);\r\n\r\n  // Mark read for current thread; only depends on thread and currentRole\r\n  useEffect(() => {\r\n    if (!thread) return;\r\n    (async () => {\r\n      try {\r\n        if (isApiEnabled) await apiMarkRead(thread.bookingId, currentRole);\r\n        else markLocalRead(thread.bookingId, currentRole);\r\n      } catch {}\r\n    })();\r\n  }, [thread, currentRole]);\r\n\r\n  // Notifications and local event bus only in local mode\r\n  useEffect(() => {\r\n    if (!thread) return undefined;\r\n    if (!isApiEnabled) {\r\n      const unsub = onCollabEvent(({ event, payload }) => {\r\n        if (!thread || payload?.bookingId !== thread.bookingId) return;\r\n        if (event === \"message\") {\r\n          const m = payload.message;\r\n          if (m.authorRole !== currentRole) {\r\n            notify(currentRole, `New ${m.channel} message`, m.content?.slice(0, 120) || \"\");\r\n          }\r\n          setThreads(listLocalThreads());\r\n        }\r\n        if (event === \"attachment\") {\r\n          setThreads(listLocalThreads());\r\n        }\r\n      });\r\n      try { if (\"Notification\" in window) Notification.requestPermission?.(); } catch {}\r\n      return () => { try { unsub?.(); } catch {} };\r\n    }\r\n    return undefined;\r\n  }, [thread, currentRole]);\r\n\r\n  // Auto-simulate WhatsApp replies\r\n  useEffect(() => {\r\n    if (!autoSync || !thread) return;\r\n    const id = setInterval(async () => {\r\n      if (isApiEnabled) {\r\n        try { await apiWhatsApp({ bookingId: thread.bookingId, fromName: \"Client\", content: \"(Auto) WhatsApp: confirmed, thanks!\" });\r\n          const list = await apiList(currentRole); setThreads(list);\r\n        } catch {}\r\n      } else {\r\n        simulateInboundWhatsApp({ bookingId: thread.bookingId, content: \"(Auto) WhatsApp: confirmed, thanks!\" });\r\n        setThreads(listLocalThreads());\r\n      }\r\n    }, 12000);\r\n    return () => clearInterval(id);\r\n  }, [autoSync, thread, currentRole]);\r\n\r\n  async function send() {\r\n    const content = message.trim();\r\n    if (!content || !thread) return;\r\n    const mentions = mention ? [mention] : [];\r\n    const payload = {\r\n      authorRole: currentRole,\r\n      authorName: roleOptions.find(r => r.value === currentRole)?.label,\r\n      content,\r\n      channel,\r\n      mentions,\r\n      visibility,\r\n    };\r\n    try {\r\n      if (isApiEnabled) {\r\n  await apiPost(thread.bookingId, payload);\r\n  const list = await apiList(currentRole); setThreads(list);\r\n      } else {\r\n        postLocalMessage(thread.bookingId, payload);\r\n        setThreads(listLocalThreads());\r\n      }\r\n    } finally {\r\n      setMessage(\"\");\r\n      setMention(\"\");\r\n    }\r\n  }\r\n\r\n  async function handleAttach(e) {\r\n    const f = e.target.files?.[0];\r\n    if (!f || !thread) return;\r\n    const meta = { name: f.name, size: f.size, type: f.type, byRole: currentRole, visibility };\r\n    if (isApiEnabled) {\r\n  await apiAttach(thread.bookingId, meta);\r\n  const list = await apiList(currentRole); setThreads(list);\r\n    } else {\r\n      addLocalAttachment(thread.bookingId, meta);\r\n      setThreads(listLocalThreads());\r\n    }\r\n  }\r\n\r\n  async function startRecording() {\r\n    try {\r\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n      const mediaRecorder = new MediaRecorder(stream);\r\n      const chunks = [];\r\n      mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };\r\n      mediaRecorder.onstop = async () => {\r\n        const blob = new Blob(chunks, { type: \"audio/webm\" });\r\n        const arrayBuffer = await blob.arrayBuffer();\r\n        const bytes = new Uint8Array(arrayBuffer);\r\n        const size = bytes.byteLength;\r\n        const url = URL.createObjectURL(blob);\r\n        const name = `voice-note-${new Date().toISOString().replace(/[:.]/g, \"-\")}.webm`;\r\n        if (isApiEnabled) {\r\n          await apiAttach(thread.bookingId, { name, size, type: \"audio/webm\", byRole: currentRole, url, visibility });\r\n          const list = await apiList(); setThreads(list);\r\n        } else {\r\n          addLocalAttachment(thread.bookingId, { name, size, type: \"audio/webm\", byRole: currentRole, url, visibility });\r\n          setThreads(listLocalThreads());\r\n        }\r\n      };\r\n      mediaRecorder.start();\r\n      setRecState({ recording: true, mediaRecorder, chunks });\r\n    } catch (e) {\r\n      console.error(\"Recording failed\", e);\r\n    }\r\n  }\r\n\r\n  function stopRecording() {\r\n    try {\r\n      recState.mediaRecorder?.stop();\r\n      setRecState({ recording: false, mediaRecorder: null, chunks: [] });\r\n    } catch {}\r\n  }\r\n\r\n  // Simple role-based visibility filter for messages\r\n  function visibleToMe(m) {\r\n    if (m.visibility === \"all\") return true;\r\n    if (m.visibility === \"agent-client\") return currentRole === ROLES.agent || currentRole === ROLES.client;\r\n    if (m.visibility === \"agent-po\") return currentRole === ROLES.agent || currentRole === ROLES.productOwner;\r\n    return true;\r\n  }\r\n  function attachmentVisibleToMe(a) { return visibleToMe(a); }\r\n\r\n  return (\r\n    <div className=\"overflow-x-hidden\">\r\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\r\n      <div className=\"space-y-6\">\r\n        <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\r\n          <h1 className=\"text-2xl font-semibold text-brand-brown\">Collaboration Workspace</h1>\r\n          <div className=\"flex flex-wrap items-center gap-3\">\r\n            <button \r\n              className=\"lg:hidden px-3 py-2 text-sm border border-cream-border rounded-md bg-white hover:bg-cream-hover\" \r\n              onClick={()=>setSidebarOpen(s=>!s)}\r\n            >\r\n              {sidebarOpen? 'Hide' : 'Show'} Bookings\r\n            </button>\r\n            <select\r\n              className=\"border border-cream-border rounded-md px-3 py-2 bg-white hover:bg-cream-hover focus:outline-none focus:ring-2 focus:ring-brand-orange/30\"\r\n              value={currentRole}\r\n              onChange={e => { setCurrentRole(e.target.value); localStorage.setItem(\"collabRole\", e.target.value); }}\r\n            >\r\n              {roleOptions.map(r => <option key={r.value} value={r.value}>{r.label}</option>)}\r\n            </select>\r\n            <RoleBadge role={currentRole} />\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"grid grid-cols-1 lg:grid-cols-12 gap-6\">\r\n          {/* Thread list */}\r\n          {sidebarOpen && (\r\n            <aside className=\"lg:col-span-3 bg-cream rounded-lg border border-cream-border shadow-sm\">\r\n              <div className=\"p-4 border-b border-cream-border font-medium text-brand-brown\">Bookings</div>\r\n              <ul className=\"max-h-[70vh] overflow-y-auto\">\r\n                {threads.map(t => (\r\n                  <li key={t.bookingId}>\r\n                    <button\r\n                      onClick={() => setBookingId(t.bookingId)}\r\n                      className={`w-full text-left px-4 py-3 hover:bg-cream-hover transition-colors ${bookingId===t.bookingId?\"bg-cream-hover\": \"\"}`}\r\n                    >\r\n                      <div className=\"flex items-center justify-between gap-2\">\r\n                        <div className=\"min-w-0 flex-1\">\r\n                          <div className=\"text-sm font-semibold text-brand-brown truncate\">{t.title}</div>\r\n                          <div className=\"text-xs text-brand-brown/70 truncate\">{t.ref} â€¢ {t.clientName}</div>\r\n                        </div>\r\n                        <div className=\"text-xs text-brand-brown/70 flex-shrink-0\">\r\n                          {t.unread?.[currentRole] ? <span className=\"inline-block min-w-5 text-center px-1.5 py-0.5 bg-brand-orange text-white rounded-full text-xs\">{t.unread[currentRole]}</span> : null}\r\n                        </div>\r\n                      </div>\r\n                    </button>\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            </aside>\r\n          )}\r\n\r\n          {/* Conversation */}\r\n          <section className={`lg:col-span-6 bg-white rounded-lg border border-cream-border shadow-sm flex flex-col ${!sidebarOpen?'lg:col-span-9':''}`}>\r\n            <div className=\"p-4 border-b border-cream-border\">\r\n              <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-3\">\r\n                <div className=\"min-w-0\">\r\n                  <div className=\"font-semibold text-brand-brown truncate\">{thread?.title || \"Select a booking\"}</div>\r\n                  <div className=\"text-xs text-brand-brown/70 truncate\">{thread?.ref} â€¢ {thread?.clientName} â€¢ Status: {thread?.status}</div>\r\n                </div>\r\n                <div className=\"flex flex-wrap items-center gap-3 text-xs\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-brand-brown/60 whitespace-nowrap\">Visibility:</span>\r\n                    <select className=\"border border-cream-border rounded px-2 py-1 text-xs bg-white hover:bg-cream-hover focus:outline-none focus:ring-1 focus:ring-brand-orange/30\" value={visibility} onChange={e=>setVisibility(e.target.value)}>\r\n                      <option value=\"all\">All Participants</option>\r\n                      <option value=\"agent-client\">Agent + Client</option>\r\n                      <option value=\"agent-po\">Agent + Product Owner</option>\r\n                    </select>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <span className=\"text-brand-brown/60 whitespace-nowrap\">Channel:</span>\r\n                    <select className=\"border border-cream-border rounded px-2 py-1 text-xs bg-white hover:bg-cream-hover focus:outline-none focus:ring-1 focus:ring-brand-orange/30\" value={channel} onChange={e=>setChannel(e.target.value)}>\r\n                      <option value={CHANNELS.inapp}>In-App</option>\r\n                      <option value={CHANNELS.whatsapp}>WhatsApp</option>\r\n                      <option value={CHANNELS.email}>Email</option>\r\n                      <option value={CHANNELS.sms}>SMS</option>\r\n                      <option value={CHANNELS.note}>Note</option>\r\n                    </select>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n          <div className=\"flex-1 overflow-y-auto p-4 space-y-3\">\r\n            {(thread?.messages || []).filter(visibleToMe).map(m => (\r\n              <div key={m.id} className={`max-w-[85%] ${m.authorRole===currentRole?\"ml-auto\":\"\"}`}>\r\n                <div className={`rounded px-3 py-2 border text-sm ${m.authorRole===ROLES.client?\"bg-cream-hover border-cream-border\":\"bg-cream border-cream-border\"}`}>\r\n                  <div className=\"flex items-center gap-2 mb-1\">\r\n                    <RoleBadge role={m.authorRole} />\r\n                    <ChannelTag channel={m.channel} />\r\n                    {m.mentions?.length ? <span className=\"text-xs text-brand-brown/70\">{m.mentions.map(x=>\"@\"+x).join(\" \")}</span> : null}\r\n                  </div>\r\n                  <div className=\"whitespace-pre-wrap text-brand-brown\">{m.content}</div>\r\n                  <div className=\"text-[11px] text-brand-brown/60 mt-1\">{new Date(m.createdAt).toLocaleString()}</div>\r\n                </div>\r\n              </div>\r\n            ))}\r\n\r\n            {/* Attachments */}\r\n            {(thread?.attachments || []).filter(attachmentVisibleToMe).length ? (\r\n              <div className=\"pt-2\">\r\n                <div className=\"text-xs font-medium text-brand-brown mb-1\">Shared Documents</div>\r\n                <ul className=\"space-y-1\">\r\n                  {thread.attachments.filter(attachmentVisibleToMe).map(a => (\r\n                    <li key={a.id} className=\"text-sm text-brand-brown border-b border-cream-border py-1\">\r\n                      <div className=\"flex items-center justify-between gap-2\">\r\n                        <span>{a.name} <span className=\"text-brand-brown/60\">({Math.ceil((a.size||0)/1024)} KB)</span></span>\r\n                        <span className=\"text-xs text-brand-brown/60\">by <RoleBadge role={a.byRole} /></span>\r\n                      </div>\r\n                      {a.type?.startsWith(\"audio/\") && a.url ? (\r\n                        <audio className=\"mt-1 w-full\" controls src={a.url} />\r\n                      ) : null}\r\n                    </li>\r\n                  ))}\r\n                </ul>\r\n              </div>\r\n            ) : null}\r\n          </div>\r\n\r\n            {/* Composer */}\r\n            <div className=\"p-4 border-t border-cream-border sticky bottom-0 bg-white\">\r\n              <div className=\"flex flex-wrap items-center gap-2 mb-2\">\r\n                <input\r\n                  className=\"flex-1 min-w-0 border border-cream-border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-orange/30\"\r\n                  placeholder=\"Write a messageâ€¦ use @client or @productOwner to mention\"\r\n                  value={message}\r\n                  onChange={e=>setMessage(e.target.value)}\r\n                />\r\n                <select className=\"border border-cream-border rounded-md px-2 py-2 text-sm bg-white hover:bg-cream-hover focus:outline-none focus:ring-1 focus:ring-brand-orange/30\" value={mention} onChange={e=>setMention(e.target.value)}>\r\n                  <option value=\"\">@Mention</option>\r\n                  <option value=\"client\">@client</option>\r\n                  <option value=\"productOwner\">@productOwner</option>\r\n                </select>\r\n                <label className=\"cursor-pointer px-3 py-2 text-sm border border-cream-border rounded-md bg-white hover:bg-cream-hover text-brand-brown transition-colors\">\r\n                  Attach\r\n                  <input type=\"file\" className=\"hidden\" onChange={handleAttach} />\r\n                </label>\r\n                {!recState.recording ? (\r\n                  <button onClick={startRecording} className=\"px-3 py-2 text-sm border border-cream-border rounded-md bg-white hover:bg-cream-hover text-brand-brown transition-colors\">Record</button>\r\n                ) : (\r\n                  <button onClick={stopRecording} className=\"px-3 py-2 text-sm border border-red-600 rounded-md bg-red-600 text-white hover:bg-red-700 transition-colors\">Stop</button>\r\n                )}\r\n                <button onClick={send} className=\"px-4 py-2 text-sm bg-brand-orange text-white rounded-md hover:bg-brand-brown transition-colors\">Send</button>\r\n              </div>\r\n              <div className=\"text-xs text-brand-brown/60\">\r\n                WhatsApp/email sync is simulated. Replies via external channels appear in the timeline with their channel tag.\r\n              </div>\r\n            </div>\r\n        </section>\r\n\r\n          {/* Insights */}\r\n          <aside className=\"lg:col-span-3 bg-cream rounded-lg border border-cream-border shadow-sm p-4 space-y-4\">\r\n            <div>\r\n              <div className=\"font-medium text-brand-brown mb-2\">AI Summary</div>\r\n              <div className=\"text-sm text-brand-brown/80 leading-relaxed\">{summary.summary}</div>\r\n              {summary.bullets?.length ? (\r\n                <ul className=\"list-disc list-inside text-sm text-brand-brown mt-3 space-y-1\">\r\n                  {summary.bullets.map((b,i)=>(<li key={i} className=\"leading-relaxed\">{b}</li>))}\r\n                </ul>\r\n              ) : null}\r\n            </div>\r\n\r\n            <div className=\"border-t border-cream-border pt-4\">\r\n              <div className=\"font-medium text-brand-brown mb-3\">Collaboration Analytics</div>\r\n              <div className=\"space-y-3\">\r\n                <div>\r\n                  <div className=\"text-xs text-brand-brown/70 mb-1\">Average response time</div>\r\n                  <ul className=\"text-sm text-brand-brown space-y-1\">\r\n                    {Object.entries(analytics.avgResponseMins || {}).map(([r, v]) => (\r\n                      <li key={r} className=\"flex items-center justify-between py-1\"><span><RoleBadge role={r} /></span><span className=\"font-medium\">{v}m</span></li>\r\n                    ))}\r\n                  </ul>\r\n                </div>\r\n                <div>\r\n                  <div className=\"text-xs text-brand-brown/70 mb-1\">Messages per channel</div>\r\n                  <ul className=\"text-sm text-brand-brown space-y-1\">\r\n                    {Object.entries(analytics.channelCounts || {}).map(([c, v]) => (\r\n                      <li key={c} className=\"flex items-center justify-between py-1\"><span><ChannelTag channel={c} /></span><span className=\"font-medium\">{v}</span></li>\r\n                    ))}\r\n                  </ul>\r\n                </div>\r\n                <div>\r\n                  <div className=\"text-xs text-brand-brown/70 mb-1\">Awaiting response</div>\r\n                  <div className=\"text-sm text-brand-brown flex flex-wrap gap-1\">\r\n                    {analytics.awaiting?.length ? analytics.awaiting.map((r,i)=>(<RoleBadge key={i} role={r} />)) : <span className=\"text-brand-brown/60\">-</span>}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"border-t border-cream-border pt-4\">\r\n              <div className=\"font-medium text-brand-brown mb-3\">Omnichannel & Push</div>\r\n              <ul className=\"text-sm text-brand-brown/90 space-y-1.5 leading-relaxed\">\r\n                <li>â€¢ WhatsApp integration stub ready (webhook-style).</li>\r\n                <li>â€¢ Email/SMS fallback simulated via channel tags.</li>\r\n                <li>â€¢ Mobile push: add FCM/Expo later for alerts.</li>\r\n                <li>â€¢ Open API hooks for Slack/Teams/CRM coming next.</li>\r\n              </ul>\r\n              <label className=\"mt-3 flex items-center gap-2 text-sm text-brand-brown cursor-pointer\">\r\n                <input \r\n                  type=\"checkbox\" \r\n                  checked={autoSync} \r\n                  onChange={e=>setAutoSync(e.target.checked)}\r\n                  className=\"rounded border-cream-border focus:ring-2 focus:ring-brand-orange/30\" \r\n                />\r\n                <span>Auto-simulate WhatsApp replies</span>\r\n              </label>\r\n              <button\r\n                onClick={() => { if(thread) { simulateInboundWhatsApp({ bookingId: thread.bookingId, content: \"Replying from WhatsApp: looks good!\" }); setThreads(listLocalThreads()); } }}\r\n                className=\"mt-3 w-full text-sm px-3 py-2 rounded-md bg-green-600 text-white hover:bg-green-700 transition-colors\"\r\n              >\r\n                Simulate WhatsApp reply\r\n              </button>\r\n            </div>\r\n        </aside>\r\n      </div>\r\n      </div>\r\n    </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":["postMessage","jsx","useState","useEffect","listLocalThreads","useMemo","markLocalRead","postLocalMessage","addLocalAttachment","jsxs"],"mappings":"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"}