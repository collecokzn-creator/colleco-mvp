{"version":3,"file":"PaymentSuccess-Dba8cgfD.js","sources":["../../src/pages/PaymentSuccess.jsx"],"sourcesContent":["import React, { useEffect, useState } from 'react';\r\nimport { confirmMockPayment, getPayment } from '../utils/payments';\r\nimport { getBooking as apiGetBooking } from '../api/client';\r\nimport { Link } from 'react-router-dom';\r\nimport { FileText } from 'lucide-react';\r\n\r\nexport default function PaymentSuccess() {\r\n  // Support both normal query string and hash-based query (used by static preview / hash router)\r\n  let params = new URLSearchParams(window.location.search);\r\n  // If no booking/session in search, attempt to parse query from the hash portion (#/path?key=v)\r\n  if ((!params.get('bookingId') && !params.get('sessionId')) && window.location.hash && window.location.hash.includes('?')) {\r\n    try {\r\n      const hashQuery = window.location.hash.split('?')[1] || '';\r\n      params = new URLSearchParams(hashQuery);\r\n    } catch (e) {\r\n      // ignore parsing errors and fall back to original params\r\n    }\r\n  }\r\n  const sessionId = params.get('sessionId');\r\n  const [status, setStatus] = useState('processing');\r\n  const [payment, setPayment] = useState(null);\r\n\r\n  const bookingId = params.get('bookingId');\r\n\r\n  async function downloadInvoice() {\r\n    if (!bookingId) {\r\n      alert('No booking ID available');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(`/api/invoices/${bookingId}/download`);\r\n      if (response.ok) {\r\n        const blob = await response.blob();\r\n        const url = window.URL.createObjectURL(blob);\r\n        const a = document.createElement('a');\r\n        a.href = url;\r\n        a.download = `Invoice_${bookingId}.pdf`;\r\n        a.click();\r\n        window.URL.revokeObjectURL(url);\r\n      } else {\r\n        alert('Failed to download invoice');\r\n      }\r\n    } catch (error) {\r\n      console.error('Invoice download failed:', error);\r\n      alert('Failed to download invoice');\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    if (bookingId) {\r\n      // E2E shortcut: allow tests to inject booking data directly via window.__E2E_BOOKING\r\n      try {\r\n        if (typeof window !== 'undefined' && window.__E2E_BOOKING && window.__E2E_BOOKING.id === bookingId) {\r\n          const b = window.__E2E_BOOKING;\r\n          if (b.pricing) {\r\n            const p = b.pricing;\r\n            setPayment({ id: b.id, amount: p.total || 0, currency: p.currency || 'ZAR', items: p.items || [], pricing: p });\r\n          } else {\r\n            const fees = b.items ? { total: b.items.reduce((s, i) => s + (Number(i.amount || i.price || 0) || 0), 0) } : null;\r\n            setPayment({ id: b.id, amount: Number(fees?.total || 0), currency: 'USD', items: b.items || [] });\r\n          }\r\n          setStatus('ok');\r\n          return;\r\n        }\r\n      } catch (e) {}\r\n      // Try to fetch booking from API (server-side)\r\n      (async () => {\r\n        try {\r\n          const res = await apiGetBooking(bookingId);\r\n          if (res && res.booking) {\r\n            // If server returned pricing breakdown, use it for display\r\n            if (res.booking.pricing) {\r\n              const p = res.booking.pricing;\r\n              setPayment({ id: res.booking.id, amount: p.total || 0, currency: p.currency || 'ZAR', items: p.items || [], pricing: p });\r\n            } else {\r\n              // convert booking into payment-like shape if possible\r\n              // fixed reduce bug: correctly sum item amounts\r\n              const fees = res.booking.items ? { total: res.booking.items.reduce((s, i) => s + (Number(i.amount || i.price || 0) || 0), 0) } : null;\r\n              setPayment({ id: res.booking.id, amount: Number(fees?.total || 0), currency: 'USD', items: res.booking.items || [] });\r\n            }\r\n            setStatus('ok');\r\n            return;\r\n          }\r\n          setStatus('error');\r\n        } catch (e) {\r\n          setStatus('error');\r\n        }\r\n      })();\r\n      return;\r\n    }\r\n    if (!sessionId) { setStatus('error'); return; }\r\n    // Confirm and fetch details (local mock)\r\n    const p = confirmMockPayment(sessionId) || getPayment(sessionId);\r\n    if (p) { setPayment(p); setStatus('ok'); }\r\n    else { setStatus('error'); }\r\n  }, [sessionId, bookingId]);\r\n\r\n  // payment and pricing are rendered directly below\r\n\r\n  return (\r\n    <div className=\"px-6 py-8 text-brand-brown\">\r\n      <h1 className=\"text-3xl font-bold mb-2\">Payment success</h1>\r\n      {status === 'processing' && <p className=\"text-brand-brown/80\">Finalizing your payment…</p>}\r\n      {status === 'ok' && (\r\n        <div className=\"bg-cream-sand p-4 border border-cream-border rounded\">\r\n          <div className=\"font-semibold mb-1\">Thank you! Your payment is confirmed.</div>\r\n          <div className=\"text-sm text-brand-brown/80\">Reference: {payment?.id}</div>\r\n          {payment?.pricing ? (\r\n              <div className=\"mt-3 text-sm text-brand-brown/80\">\r\n              <div className=\"font-semibold\">Pricing breakdown</div>\r\n              <div className=\"mt-1\">Subtotal: {payment.pricing.currency} {Number(payment.pricing.subtotal || 0).toFixed(2)}</div>\r\n              <div>CollEco service fees: {payment.pricing.currency} {Number(payment.pricing.totalServiceFees || 0).toFixed(2)}</div>\r\n              <div>Partner commission ({payment.pricing.commissionTier || ''} @ {Math.round((payment.pricing.commissionRate||0)*100)}%): {payment.pricing.currency} {Number(payment.pricing.commission || 0).toFixed(2)}</div>\r\n              <div className=\"font-semibold mt-1\">Partner receives: {payment.pricing.currency} {Number(payment.pricing.partnerReceives || 0).toFixed(2)}</div>\r\n              <div className=\"mt-1\">Total charged: {payment.pricing.currency} {Number(payment.pricing.total || 0).toFixed(2)}</div>\r\n            </div>\r\n          ) : (\r\n            (payment?.items?.length ? (\r\n              <div className=\"mt-3\">\r\n                <div className=\"text-sm font-semibold mb-1\">Summary</div>\r\n                <ul className=\"text-sm list-disc list-inside\">\r\n                  {payment.items.map((i, idx) => (\r\n                    <li key={idx}>{i.name} — ${Number(i.amount || 0).toFixed(2)}</li>\r\n                  ))}\r\n                </ul>\r\n              </div>\r\n            ) : null)\r\n          )}\r\n          <div className=\"mt-4 flex gap-3\">\r\n            <Link to=\"/bookings\" className=\"px-3 py-2 bg-brand-orange text-white rounded hover:bg-orange-600 transition\">\r\n              Back to Bookings\r\n            </Link>\r\n            <button\r\n              onClick={downloadInvoice}\r\n              className=\"px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 transition flex items-center gap-2\"\r\n              title=\"Download invoice PDF\"\r\n            >\r\n              <FileText className=\"h-4 w-4\" />\r\n              Download Invoice\r\n            </button>\r\n          </div>\r\n        </div>\r\n      )}\r\n  {status === 'error' && <p className=\"text-red-600\">We couldn&apos;t find your session.</p>}\r\n    </div>\r\n  );\r\n}\r\n"],"names":["useState","useEffect","p","apiGetBooking","jsxs","jsx"],"mappings":"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"}