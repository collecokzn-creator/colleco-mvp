import{r as l,j as e}from"./index-E_l07fEO.js";const N="http://localhost:4000";function y(s,p=4e3){const[n,i]=l.useState(null),[u,w]=l.useState(""),h=l.useRef(null);return l.useEffect(()=>{let m=!0;async function j(){try{const d=await fetch(s);if(!d.ok)throw new Error(await d.text()||"Request failed");const x=await d.json();m&&i(x)}catch(d){m&&w(d.message||"Error")}}return j(),h.current=setInterval(j,p),()=>{m=!1,clearInterval(h.current)}},[s,p]),{data:n,error:u}}function H(){const{data:s,error:p}=y(`${N}/api/ai/metrics`,5e3),{data:n}=y(`${N}/api/ai/metrics/history`,1e4),{data:i}=y(`${N}/api/ai/config`,2e4),[u,w]=l.useState([]),[h,m]=l.useState([]),[j,d]=l.useState([]),[x,k]=l.useState([]);l.useEffect(()=>{if(s){w(r=>[...r.slice(-49),{t:Date.now(),total:s.total,cacheHits:s.cacheHits,cacheMiss:s.cacheMiss}]),m(r=>[...r.slice(-49),{t:Date.now(),refine:s.refine}]);const t=s.cacheHits+s.cacheMiss||0;if(t){const r=s.cacheHits/t*100;d(o=>[...o.slice(-49),{t:Date.now(),ratio:r}])}s.tokens&&typeof s.tokens.total=="number"&&k(r=>[...r.slice(-49),{t:Date.now(),tokens:s.tokens.total}])}},[s]);const D=l.useRef(!1);l.useEffect(()=>{if(n&&Array.isArray(n.samples)&&n.samples.length&&!D.current){D.current=!0;const t=n.samples.slice(-100),r=t.map(a=>({t:a.ts,total:a.total,cacheHits:a.cacheHits,cacheMiss:a.cacheMiss})),o=t.map(a=>({t:a.ts,refine:a.refine})),f=t.filter(a=>a.cacheHits+a.cacheMiss>0).map(a=>({t:a.ts,ratio:a.cacheHits/(a.cacheHits+a.cacheMiss)*100})),c=t.filter(a=>a.tokens&&typeof a.tokens.total=="number").map(a=>({t:a.ts,tokens:a.tokens.total}));w(r),m(o),d(f),c.length&&k(c)}},[n]);function v(t,r="total",o="#c2410c"){if(!t.length)return null;const f=Math.max(...t.map(g=>g[r])),c=Math.min(...t.map(g=>g[r])),a=f-c||1,L=t.map((g,M)=>{const R=M/(t.length-1)*100,P=100-(g[r]-c)/a*100;return`${R},${P}`}).join(" ");return e.jsx("svg",{viewBox:"0 0 100 100",preserveAspectRatio:"none",className:"w-full h-full",children:e.jsx("polyline",{fill:"none",stroke:o,strokeWidth:"2",points:L})})}function b(t,r,o){const{warn:f=300,danger:c=800}=o||{};let a="bg-emerald-200 text-emerald-900";return r>=c?a="bg-red-300 text-red-900":r>=f&&(a="bg-amber-300 text-amber-900"),e.jsxs("span",{className:`px-1.5 py-0.5 rounded text-[10px] font-semibold tracking-wide ${a}`,children:[t," ",r,"ms"]})}return e.jsxs("div",{className:"max-w-3xl mx-auto p-6 flex flex-col gap-6","aria-labelledby":"aiMetricsHeading",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4 flex-wrap",children:[e.jsx("h1",{id:"aiMetricsHeading",className:"text-2xl font-bold text-brand-brown",children:"AI Metrics"}),e.jsx("button",{type:"button",onClick:()=>{window.open(`${N}/api/ai/metrics/history/download`,"_blank")},className:"text-[11px] px-3 py-1 rounded bg-brand-brown text-cream-sand font-semibold hover:bg-brand-brown/90 focus:outline-none focus:ring-2 focus:ring-brand-brown/50",children:"Download History"})]}),e.jsx("p",{className:"text-sm text-brand-brown/70 leading-snug",children:"Live heuristic AI usage counters (ephemeral, reset on server restart). Polls every 5s."}),i&&i.llm&&e.jsxs("div",{className:"text-[11px] flex flex-wrap gap-2 items-center",children:[e.jsxs("span",{className:"px-2 py-0.5 rounded bg-brand-brown/10 text-brand-brown uppercase tracking-wide",children:["LLM: ",i.llm.provider]}),i.llm.model&&e.jsxs("span",{className:"px-2 py-0.5 rounded bg-cream-sand border border-cream-border text-brand-brown",children:["model: ",i.llm.model]}),i.hybridLLM?e.jsx("span",{className:"px-2 py-0.5 rounded bg-emerald-100 text-emerald-900",children:"hybrid on"}):e.jsx("span",{className:"px-2 py-0.5 rounded bg-amber-100 text-amber-900",children:"hybrid off"})]}),p&&e.jsx("div",{className:"bg-red-100 border border-red-300 text-red-700 px-3 py-2 rounded text-sm",children:p}),e.jsx("div",{className:"grid sm:grid-cols-3 gap-4",children:s&&[{label:"Total",value:s.total},{label:"Cache Hits",value:s.cacheHits},{label:"Cache Miss",value:s.cacheMiss},{label:"Refines",value:s.refine},{label:"Drafts",value:s.drafts},{label:"Rate Limited",value:s.rateLimited}].map(t=>e.jsxs("div",{className:"p-3 rounded border border-cream-border bg-cream-sand/40 flex flex-col gap-1",children:[e.jsx("div",{className:"text-xs font-semibold text-brand-brown/80 uppercase tracking-wide",children:t.label}),e.jsx("div",{className:"text-lg font-bold text-brand-brown",children:t.value})]},t.label))}),e.jsxs("div",{className:"grid sm:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"h-24 border border-cream-border rounded bg-cream-sand/40 p-2",children:[e.jsxs("div",{className:"text-[11px] font-semibold mb-1 text-brand-brown/70",children:["Total Requests (",u.length,")"]}),e.jsx("div",{className:"w-full h-16",children:v(u,"total","#c2410c")})]}),e.jsxs("div",{className:"h-24 border border-cream-border rounded bg-cream-sand/40 p-2",children:[e.jsxs("div",{className:"text-[11px] font-semibold mb-1 text-brand-brown/70",children:["Refine Requests (",h.length,")"]}),e.jsx("div",{className:"w-full h-16",children:v(h,"refine","#92400e")})]}),e.jsxs("div",{className:"h-24 border border-cream-border rounded bg-cream-sand/40 p-2",children:[e.jsx("div",{className:"text-[11px] font-semibold mb-1 text-brand-brown/70",children:"Cache Hit Ratio (%)"}),e.jsx("div",{className:"w-full h-16",children:v(j,"ratio","#065f46")})]})]}),x.length>0&&e.jsxs("div",{className:"h-24 border border-cream-border rounded bg-cream-sand/40 p-2",children:[e.jsxs("div",{className:"text-[11px] font-semibold mb-1 text-brand-brown/70",children:["Total Tokens (",x[x.length-1].tokens,")"]}),e.jsx("div",{className:"w-full h-16",children:v(x,"tokens","#1d4ed8")})]}),s&&s.latencyPercentiles&&e.jsxs("div",{className:"grid sm:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-3 rounded border border-cream-border bg-cream-sand/40 text-[11px] flex flex-col gap-1",children:[e.jsx("div",{className:"font-semibold",children:"Latency (gen)"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[b("P50",s.latencyPercentiles.gen.p50,{warn:300,danger:800}),b("P95",s.latencyPercentiles.gen.p95,{warn:500,danger:1200}),b("P99",s.latencyPercentiles.gen.p99,{warn:700,danger:1500}),e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-brand-brown/10 text-brand-brown font-semibold",children:["Avg ",s.avgLatencyMs?.gen,"ms"]})]})]}),e.jsxs("div",{className:"p-3 rounded border border-cream-border bg-cream-sand/40 text-[11px] flex flex-col gap-1",children:[e.jsx("div",{className:"font-semibold",children:"Latency (refine)"}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[b("P50",s.latencyPercentiles.refine.p50,{warn:300,danger:800}),b("P95",s.latencyPercentiles.refine.p95,{warn:500,danger:1200}),b("P99",s.latencyPercentiles.refine.p99,{warn:700,danger:1500}),e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-brand-brown/10 text-brand-brown font-semibold",children:["Avg ",s.avgLatencyMs?.refine,"ms"]})]})]})]}),s&&s.rateLimit&&e.jsxs("div",{className:"p-3 rounded border border-cream-border bg-cream-sand/40 text-[11px] flex flex-col gap-1",children:[e.jsx("div",{className:"font-semibold mb-1",children:"Rate Limit"}),e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("span",{className:"px-2 py-0.5 bg-brand-brown/10 rounded text-brand-brown text-[10px] uppercase tracking-wide",children:s.rateLimit.strategy}),s.rateLimit.strategy==="token_bucket"&&e.jsxs("span",{children:["capacity ",s.rateLimit.capacity," • refill ",s.rateLimit.refillMs,"ms"]}),s.rateLimit.strategy==="sliding_window"&&e.jsxs("span",{children:["window ",s.rateLimit.windowMs,"ms • max ",s.rateLimit.max]})]})]}),n&&Array.isArray(n.samples)&&n.samples.length>0&&(()=>{const t=n.samples[n.samples.length-1];if(!t||!(t.tokensDelta||typeof t.costDelta=="number"||typeof t.totalDelta=="number"))return null;const o=typeof t.totalDelta=="number"?(t.totalDelta/10).toFixed(2):"0.00";return e.jsxs("div",{className:"p-3 rounded border border-cream-border bg-cream-sand/40 text-[11px] grid sm:grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-0.5",children:"Last Interval Requests"}),e.jsxs("div",{className:"font-bold text-brand-brown text-sm",children:[t.totalDelta??!0?"+":"",t.totalDelta??0]}),e.jsxs("div",{className:"text-[10px] text-brand-brown/60",children:["~10s window • ",o,"/s"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-0.5",children:"Token Delta (total)"}),e.jsx("div",{className:"font-bold text-brand-brown text-sm",children:t.tokensDelta?(t.tokensDelta.total>=0?"+":"")+t.tokensDelta.total:"0"}),t.tokensDelta&&e.jsxs("div",{className:"text-[10px] text-brand-brown/60",children:["prompt ",t.tokensDelta.prompt>=0?"+":"",t.tokensDelta.prompt," • completion ",t.tokensDelta.completion>=0?"+":"",t.tokensDelta.completion]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold mb-0.5",children:"Cost Δ (USD)"}),e.jsxs("div",{className:"font-bold text-brand-brown text-sm",children:[t.costDelta>=0?"+":"",t.costDelta?.toFixed?t.costDelta.toFixed(6):t.costDelta]}),e.jsxs("div",{className:"text-[10px] text-brand-brown/60",children:["cumulative ",s?.costUsd?.toFixed?s.costUsd.toFixed(6):s?.costUsd]})]})]})})(),s&&s.tokens&&e.jsx("div",{className:"grid sm:grid-cols-4 gap-4",children:[{label:"Prompt Tokens",v:s.tokens.prompt},{label:"Completion Tokens",v:s.tokens.completion},{label:"Total Tokens",v:s.tokens.total},{label:"Est. Cost (USD)",v:s.costUsd?.toFixed?s.costUsd.toFixed(6):s.costUsd}].map(t=>e.jsxs("div",{className:"p-3 rounded border border-cream-border bg-cream-sand/40 flex flex-col gap-1",children:[e.jsx("div",{className:"text-[10px] font-semibold uppercase tracking-wide text-brand-brown/70",children:t.label}),e.jsx("div",{className:"text-sm font-bold text-brand-brown break-all",children:t.v})]},t.label))}),s&&e.jsxs("details",{className:"text-xs",children:[e.jsx("summary",{className:"cursor-pointer font-semibold",children:"Raw JSON"}),e.jsx("pre",{className:"bg-cream-sand border border-cream-border rounded p-2 overflow-auto max-h-64 whitespace-pre-wrap break-all",children:JSON.stringify(s,null,2)})]}),e.jsx("p",{className:"text-[11px] text-brand-brown/60",children:"History-backed visualization (snapshots every ~10s). Includes latency percentiles & token/cost metrics when hybrid mode is active."})]})}export{H as default};
