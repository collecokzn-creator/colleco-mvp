import{r as x,j as e}from"./index-E_l07fEO.js";import{a as I,c as L,R as f}from"./collabStore-RBK6R8ls.js";function V(){const[w,A]=x.useState(()=>I()),[C,B]=x.useState(""),[M,E]=x.useState(""),[R,$]=x.useState(""),[O,U]=x.useState(60);x.useEffect(()=>{A(I())},[]);const k=x.useMemo(()=>{const t=C.trim().toLowerCase();return t?w.filter(a=>`${a.ref} ${a.clientName} ${a.title}`.toLowerCase().includes(t)):w},[w,C]),y=t=>{if(!t)return!1;const a=new Date(t);if(M){const b=new Date(M+"T00:00:00");if(a<b)return!1}if(R){const b=new Date(R+"T23:59:59");if(a>b)return!1}return!0},o=x.useMemo(()=>{const t={totalThreads:0,totalMessages:0,totalAttachments:0,channelCounts:{},avgResponseByRole:{},awaitingCounts:{},bottlenecks:[],dailyCounts:{}},a={},b={};for(const l of k){const c=(l.messages||[]).filter(s=>y(s.createdAt)),i=(l.attachments||[]).filter(s=>y(s.addedAt));if(c.length===0&&i.length===0)continue;t.totalThreads+=1,t.totalMessages+=c.length,t.totalAttachments+=i.length;for(const s of c)t.channelCounts[s.channel]=(t.channelCounts[s.channel]||0)+1;const m=c.slice().sort((s,r)=>s.createdAt-r.createdAt),p={};let N=null,g=null;for(const s of m){if(N&&s.authorRole!==N&&g){const r=Math.max(0,Math.round((s.createdAt-g)/6e4));(p[s.authorRole]=p[s.authorRole]||[]).push(r)}N=s.authorRole,g=s.createdAt}const v=Object.fromEntries(Object.entries(p).map(([s,r])=>[s,Math.round(r.reduce((T,h)=>T+h,0)/r.length)]));for(const[s,r]of Object.entries(v))a[s]=(a[s]||0)+r,b[s]=(b[s]||0)+1;const j=L(l);for(const s of j.awaiting||[])t.awaitingCounts[s]=(t.awaitingCounts[s]||0)+1;const u=(l.messages||[]).slice().sort((s,r)=>s.createdAt-r.createdAt);if(u.length){const s=u[u.length-1],r=Math.round((Date.now()-s.createdAt)/6e4);t.bottlenecks.push({bookingId:l.bookingId,ref:l.ref,title:l.title,clientName:l.clientName,ageMin:r,awaiting:j.awaiting})}for(const s of c){const r=new Date(s.createdAt).toISOString().slice(0,10);t.dailyCounts[r]=(t.dailyCounts[r]||0)+1}}for(const l of Object.keys(a))t.avgResponseByRole[l]=Math.round(a[l]/Math.max(1,b[l]));return t.bottlenecks.sort((l,c)=>c.ageMin-l.ageMin),t},[k]),S=t=>t===f.agent?"Agent":t===f.client?"Client":t===f.productOwner?"Product Owner":t,P=()=>{const t=[["bookingId","ref","title","clientName","messagesInRange","attachmentsInRange","lastMsgAgeMin","awaiting","avgRespAgent","avgRespClient","avgRespPO","inapp","whatsapp","email","sms","call","note"]];o.dailyCounts;for(const i of k){const m=(i.messages||[]).filter(n=>y(n.createdAt)),p=(i.attachments||[]).filter(n=>y(n.addedAt));if(m.length===0&&p.length===0)continue;const N=m.slice().sort((n,d)=>n.createdAt-d.createdAt),g={};let v=null,j=null;for(const n of N){if(v&&n.authorRole!==v&&j){const d=Math.max(0,Math.round((n.createdAt-j)/6e4));(g[n.authorRole]=g[n.authorRole]||[]).push(d)}v=n.authorRole,j=n.createdAt}const u=Object.fromEntries(Object.entries(g).map(([n,d])=>[n,Math.round(d.reduce((q,z)=>q+z,0)/d.length)])),s=L(i),r=(i.messages||[]).slice().sort((n,d)=>n.createdAt-d.createdAt),T=r.length?Math.round((Date.now()-r[r.length-1].createdAt)/6e4):"",h=m.reduce((n,d)=>(n[d.channel]=(n[d.channel]||0)+1,n),{});t.push([i.bookingId,i.ref,i.title,i.clientName,m.length,p.length,T,(s.awaiting||[]).join("|"),u[f.agent]||"",u[f.client]||"",u[f.productOwner]||"",h["in-app"]||0,h.whatsapp||0,h.email||0,h.sms||0,h.call||0,h.note||0])}const a=t.map(i=>i.map(m=>typeof m=="string"?'"'+m.replaceAll('"','""')+'"':m).join(",")).join(`
`),b=new Blob([a],{type:"text/csv;charset=utf-8"}),l=URL.createObjectURL(b),c=document.createElement("a");c.href=l,c.download=`collab-analytics-${new Date().toISOString().slice(0,10)}.csv`,document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(l)};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("h1",{className:"text-2xl font-semibold text-brand-brown",children:"Collaboration Analytics"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("input",{className:"border rounded px-3 py-1.5 bg-cream hover:bg-cream-hover w-56",placeholder:"Search by ref, client, title",value:C,onChange:t=>B(t.target.value)}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1.5",value:M,onChange:t=>E(t.target.value)}),e.jsx("span",{className:"text-brand-brown/60",children:"to"}),e.jsx("input",{type:"date",className:"border rounded px-2 py-1.5",value:R,onChange:t=>$(t.target.value)}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-sm text-brand-brown/70",children:"SLA (mins)"}),e.jsx("input",{type:"number",min:"1",className:"w-20 border rounded px-2 py-1.5",value:O,onChange:t=>U(Number(t.target.value)||0)})]}),e.jsx("button",{onClick:P,className:"px-3 py-1.5 rounded bg-brand-orange text-white hover:opacity-95",children:"Export CSV"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(D,{label:"Active Threads",value:o.totalThreads}),e.jsx(D,{label:"Messages",value:o.totalMessages}),e.jsx(D,{label:"Attachments",value:o.totalAttachments})]}),e.jsxs("div",{className:"bg-white rounded border border-cream-border p-4",children:[e.jsx("h2",{className:"font-semibold text-brand-brown mb-2",children:"Daily Messages Trend"}),Object.keys(o.dailyCounts).length===0?e.jsx("div",{className:"text-sm text-brand-brown/60",children:"No messages in selected range."}):e.jsx("div",{className:"space-y-1",children:Object.entries(o.dailyCounts).sort(([t],[a])=>t.localeCompare(a)).map(([t,a])=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-24 text-xs text-brand-brown/70",children:t}),e.jsx("div",{className:"flex-1 bg-cream h-3 rounded",children:e.jsx("div",{className:"bg-brand-orange h-3 rounded",style:{width:`${Math.min(100,a/Math.max(1,Math.max(...Object.values(o.dailyCounts)))*100)}%`}})}),e.jsx("div",{className:"w-10 text-xs text-brand-brown/70 text-right",children:a})]},t))})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-cream rounded border border-cream-border p-4",children:[e.jsx("h2",{className:"font-semibold text-brand-brown mb-2",children:"Average Response (mins) by Role"}),e.jsx("ul",{className:"text-sm text-brand-brown space-y-1",children:Object.keys(o.avgResponseByRole).length===0?e.jsx("li",{className:"text-brand-brown/60",children:"No data yet."}):Object.entries(o.avgResponseByRole).map(([t,a])=>e.jsxs("li",{className:"flex items-center justify-between border-b border-cream-border py-1",children:[e.jsx("span",{children:S(t)}),e.jsxs("span",{children:[a,"m"]})]},t))})]}),e.jsxs("div",{className:"bg-cream rounded border border-cream-border p-4",children:[e.jsx("h2",{className:"font-semibold text-brand-brown mb-2",children:"Messages by Channel"}),e.jsx("ul",{className:"text-sm text-brand-brown space-y-1",children:Object.keys(o.channelCounts).length===0?e.jsx("li",{className:"text-brand-brown/60",children:"No messages yet."}):Object.entries(o.channelCounts).map(([t,a])=>e.jsxs("li",{className:"flex items-center justify-between border-b border-cream-border py-1",children:[e.jsx("span",{className:"capitalize",children:t}),e.jsx("span",{children:a})]},t))})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white rounded border border-cream-border p-4",children:[e.jsx("h2",{className:"font-semibold text-brand-brown mb-2",children:"Awaiting Response"}),e.jsx("ul",{className:"text-sm text-brand-brown space-y-1",children:Object.keys(o.awaitingCounts).length===0?e.jsx("li",{className:"text-brand-brown/60",children:"All clear."}):Object.entries(o.awaitingCounts).map(([t,a])=>e.jsxs("li",{className:"flex items-center justify-between border-b border-cream-border py-1",children:[e.jsx("span",{children:S(t)}),e.jsxs("span",{children:[a," thread(s)"]})]},t))})]}),e.jsxs("div",{className:"bg-white rounded border border-cream-border p-4",children:[e.jsx("h2",{className:"font-semibold text-brand-brown mb-2",children:"Top Bottlenecks"}),e.jsx("ul",{className:"text-sm text-brand-brown space-y-2",children:o.bottlenecks.length===0?e.jsx("li",{className:"text-brand-brown/60",children:"No bottlenecks detected."}):o.bottlenecks.slice(0,5).map(t=>e.jsxs("li",{className:`border-b border-cream-border pb-2 ${t.ageMin>O?"bg-red-50":""}`,children:[e.jsxs("div",{className:"font-medium",children:[t.title," ",e.jsxs("span",{className:"text-brand-brown/60",children:["(",t.ref,")"]}),t.ageMin>O?e.jsx("span",{className:"ml-2 text-xs text-red-700",children:"SLA breached"}):null]}),e.jsx("div",{className:"text-xs text-brand-brown/70",children:t.clientName}),e.jsxs("div",{className:"text-xs text-brand-brown/70 mt-1",children:["Last message: ",t.ageMin,"m ago"]}),e.jsxs("div",{className:"text-xs text-brand-brown/70",children:["Awaiting: ",t.awaiting?.length?t.awaiting.map(S).join(", "):"-"]})]},t.bookingId))})]})]})]})}function D({label:w,value:A}){return e.jsxs("div",{className:"bg-white rounded border border-cream-border p-4",children:[e.jsx("div",{className:"text-brand-brown/70 text-sm",children:w}),e.jsx("div",{className:"text-2xl font-semibold text-brand-brown",children:A})]})}export{V as default};
