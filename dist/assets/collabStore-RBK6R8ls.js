const g="collabThreads:v1",i={agent:"agent",client:"client",productOwner:"productOwner",system:"system"},d={inapp:"in-app",whatsapp:"whatsapp",email:"email",sms:"sms",call:"call",note:"note"};function l(){try{const t=localStorage.getItem(g);return t?JSON.parse(t):{}}catch(t){return console.error("Failed to load collab threads",t),{}}}const m=new Set;function N(t){return m.add(t),()=>m.delete(t)}function y(t,a){try{m.forEach(e=>e({event:t,payload:a}))}catch{}}function p(t){try{localStorage.setItem(g,JSON.stringify(t))}catch(a){console.error("Failed to save collab threads",a)}}function R(t,a=[]){const e=l();return e[t.id]||(e[t.id]={bookingId:t.id,ref:t.ref,title:t.itineraryName||"Booking",clientName:t.clientName,status:t.status||"Draft",participants:a,messages:[],attachments:[],unread:{},createdAt:Date.now(),updatedAt:Date.now()},p(e)),e[t.id]}function v(){const t=l();return Object.values(t).sort((a,e)=>(e.updatedAt||0)-(a.updatedAt||0))}function h(t,a){const e=l();if(!e[t])return;const n={id:crypto.randomUUID(),createdAt:Date.now(),mentions:[],attachments:[],visibility:"all",channel:d.inapp,...a},s=e[t];s.messages.push(n),s.updatedAt=Date.now();for(const c of s.participants||[])c.role!==n.authorRole&&(s.unread[c.role]=(s.unread[c.role]||0)+1);return p(e),y("message",{bookingId:t,message:n}),n}function O(t,a){const e=l();if(!e[t])return;const n={id:crypto.randomUUID(),addedAt:Date.now(),visibility:"all",...a};e[t].attachments.push(n),e[t].updatedAt=Date.now();for(const s of e[t].participants||[])s.role!==n.byRole&&(e[t].unread[s.role]=(e[t].unread[s.role]||0)+1);return p(e),y("attachment",{bookingId:t,attachment:n}),n}function S(t,a){const e=l();e[t]&&(e[t].unread[a]=0,p(e))}function D(t){if(!t)return{avgResponseMins:{},channelCounts:{},awaiting:[]};const a=[...t.messages||[]].sort((r,o)=>r.createdAt-o.createdAt),e={},n={};let s=null,c=null;for(const r of a){if(n[r.channel]=(n[r.channel]||0)+1,s&&r.authorRole!==s&&c){const o=Math.max(0,Math.round((r.createdAt-c)/6e4));(e[r.authorRole]=e[r.authorRole]||[]).push(o)}s=r.authorRole,c=r.createdAt}const w=Object.fromEntries(Object.entries(e).map(([r,o])=>[r,Math.round(o.reduce((u,A)=>u+A,0)/o.length)])),f=[];if(a.length){const r=a[a.length-1],o=(t.participants||[]).map(u=>u.role).filter(u=>u!==r.authorRole);f.push(...o)}return{avgResponseMins:w,channelCounts:n,awaiting:f}}function T(t){const a=(t?.messages||[]).map(s=>s.content||"").join(`
`);if(!a.trim())return{summary:"No messages yet.",bullets:[]};const e=[],n=a.toLowerCase();return(n.includes("pickup")||n.includes("transfer"))&&e.push("Add airport pickup"),n.includes("upgrade")&&e.push("Upgrade room/category"),n.includes("flight")&&(n.includes("time")||n.includes("shift"))&&e.push("Shift flight time"),n.includes("quote")&&n.includes("update")&&e.push("Update quote"),{summary:e.length?`Top requested changes: ${e.join(", ")}.`:"Conversation summarized.",bullets:e}}function C(t){const a=l();for(const e of t)a[e.id]||(R(e,[{role:i.agent,name:"Agent"},{role:i.client,name:e.clientName},{role:i.productOwner,name:"Hotel/Supplier"}]),h(e.id,{authorRole:i.agent,authorName:"Agent",channel:d.inapp,content:`Hi ${e.clientName}, your ${e.itineraryName} itinerary is ready. Would you like an airport pickup added?`}),h(e.id,{authorRole:i.client,authorName:e.clientName,channel:d.whatsapp,content:"Yes please, also can we upgrade the room and shift the flight time by 1 hour?"}),h(e.id,{authorRole:i.productOwner,authorName:"Hotel/Supplier",channel:d.email,content:"Room upgrade available at +$50/night. Awaiting confirmation."}))}export{d as C,i as R,v as a,T as b,D as c,O as d,l,S as m,N as o,h as p,C as s};
